[2025-12-21 17:15:20,416] {taskinstance.py:1032} INFO - Dependencies all met for <TaskInstance: SolovevEgor_HW_05_ds_20259834765986593865.run_query1 scheduled__2025-12-20T17:15:10.739199+00:00 [queued]>
[2025-12-21 17:15:20,435] {taskinstance.py:1032} INFO - Dependencies all met for <TaskInstance: SolovevEgor_HW_05_ds_20259834765986593865.run_query1 scheduled__2025-12-20T17:15:10.739199+00:00 [queued]>
[2025-12-21 17:15:20,435] {taskinstance.py:1238} INFO - 
--------------------------------------------------------------------------------
[2025-12-21 17:15:20,435] {taskinstance.py:1239} INFO - Starting attempt 1 of 2
[2025-12-21 17:15:20,435] {taskinstance.py:1240} INFO - 
--------------------------------------------------------------------------------
[2025-12-21 17:15:20,450] {taskinstance.py:1259} INFO - Executing <Task(PostgresOperator): run_query1> on 2025-12-20 17:15:10.739199+00:00
[2025-12-21 17:15:20,466] {standard_task_runner.py:76} INFO - Running: ['***', 'tasks', 'run', 'SolovevEgor_HW_05_ds_20259834765986593865', 'run_query1', 'scheduled__2025-12-20T17:15:10.739199+00:00', '--job-id', '234', '--raw', '--subdir', 'DAGS_FOLDER/SolovevEgor_HW_06_ds_2025.py', '--cfg-path', '/tmp/tmpq6wru_ey', '--error-file', '/tmp/tmpny2plxdm']
[2025-12-21 17:15:20,466] {standard_task_runner.py:77} INFO - Job 234: Subtask run_query1
[2025-12-21 17:15:20,456] {standard_task_runner.py:52} INFO - Started process 2873 to run task
[2025-12-21 17:15:20,548] {logging_mixin.py:109} INFO - Running <TaskInstance: SolovevEgor_HW_05_ds_20259834765986593865.run_query1 scheduled__2025-12-20T17:15:10.739199+00:00 [running]> on host b97b26732d6a
[2025-12-21 17:15:20,611] {taskinstance.py:1426} INFO - Exporting the following env vars:
AIRFLOW_CTX_DAG_OWNER=Solovev Egor
AIRFLOW_CTX_DAG_ID=SolovevEgor_HW_05_ds_20259834765986593865
AIRFLOW_CTX_TASK_ID=run_query1
AIRFLOW_CTX_EXECUTION_DATE=2025-12-20T17:15:10.739199+00:00
AIRFLOW_CTX_DAG_RUN_ID=scheduled__2025-12-20T17:15:10.739199+00:00
[2025-12-21 17:15:20,623] {base.py:79} INFO - Using connection to: id: postgresql. Host: postgres, Port: 5432, Schema: postgres, Login: ***, Password: ***, extra: {}
[2025-12-21 17:15:20,629] {dbapi.py:225} INFO - Running statement: /* Query 5
 * 
 * 5. Найти имена и фамилии клиентов с топ-3 минимальной
      и топ-3 максимальной суммой транзакций за весь период
      (учесть клиентов, у которых нет заказов, приняв их сумму транзакций за 0).
*/

with transaction_amount_per_customer as (
	select
		o.customer_id,
		trunc(coalesce(sum(oi.quantity * oi.item_list_price_at_sale), 0)::numeric, 2) as amount
	from
		orders as o
	join order_items as oi on oi.order_id = o.order_id
	group by
		o.customer_id
),
transactions_rank as (
	select
		customer_id,
		amount,
		rank() over(order by amount asc) as top3_min_amount,
		rank() over(order by amount desc) as top3_max_amount
	from
		transaction_amount_per_customer
)
select
	c.first_name,
	c.last_name,
	coalesce(tr.amount, 0) as amount,
	coalesce(top3_min_amount, 0) as top3_min_amount,
	coalesce(top3_max_amount, 0) as top3_max_amount
from
	transactions_rank tr
right join (	select customer_id, first_name, coalesce(last_name, 'n\a') as last_name
			from customer) c on c.customer_id = tr.customer_id
where tr.top3_min_amount <=3 or tr.top3_max_amount <=3
;, parameters: None
[2025-12-21 17:15:20,670] {dbapi.py:233} INFO - Rows affected: 6
[2025-12-21 17:15:20,689] {taskinstance.py:1277} INFO - Marking task as SUCCESS. dag_id=SolovevEgor_HW_05_ds_20259834765986593865, task_id=run_query1, execution_date=20251220T171510, start_date=20251221T171520, end_date=20251221T171520
[2025-12-21 17:15:20,725] {local_task_job.py:154} INFO - Task exited with return code 0
[2025-12-21 17:15:20,755] {local_task_job.py:264} INFO - 0 downstream tasks scheduled from follow-on schedule check
