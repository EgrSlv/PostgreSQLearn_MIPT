[2025-12-21 17:49:46,578] {taskinstance.py:1032} INFO - Dependencies all met for <TaskInstance: SolovevEgor_HW_05_ds_2025.run_query1 manual__2025-12-21T17:49:42.490411+00:00 [queued]>
[2025-12-21 17:49:46,587] {taskinstance.py:1032} INFO - Dependencies all met for <TaskInstance: SolovevEgor_HW_05_ds_2025.run_query1 manual__2025-12-21T17:49:42.490411+00:00 [queued]>
[2025-12-21 17:49:46,588] {taskinstance.py:1238} INFO - 
--------------------------------------------------------------------------------
[2025-12-21 17:49:46,588] {taskinstance.py:1239} INFO - Starting attempt 1 of 2
[2025-12-21 17:49:46,588] {taskinstance.py:1240} INFO - 
--------------------------------------------------------------------------------
[2025-12-21 17:49:46,599] {taskinstance.py:1259} INFO - Executing <Task(PostgresOperator): run_query1> on 2025-12-21 17:49:42.490411+00:00
[2025-12-21 17:49:46,607] {standard_task_runner.py:76} INFO - Running: ['***', 'tasks', 'run', 'SolovevEgor_HW_05_ds_2025', 'run_query1', 'manual__2025-12-21T17:49:42.490411+00:00', '--job-id', '314', '--raw', '--subdir', 'DAGS_FOLDER/SolovevEgor_HW_06_ds_2025.py', '--cfg-path', '/tmp/tmpz6trcc0m', '--error-file', '/tmp/tmpwbili066']
[2025-12-21 17:49:46,609] {standard_task_runner.py:77} INFO - Job 314: Subtask run_query1
[2025-12-21 17:49:46,603] {standard_task_runner.py:52} INFO - Started process 4687 to run task
[2025-12-21 17:49:46,664] {logging_mixin.py:109} INFO - Running <TaskInstance: SolovevEgor_HW_05_ds_2025.run_query1 manual__2025-12-21T17:49:42.490411+00:00 [running]> on host b97b26732d6a
[2025-12-21 17:49:46,716] {taskinstance.py:1426} INFO - Exporting the following env vars:
AIRFLOW_CTX_DAG_OWNER=Solovev Egor
AIRFLOW_CTX_DAG_ID=SolovevEgor_HW_05_ds_2025
AIRFLOW_CTX_TASK_ID=run_query1
AIRFLOW_CTX_EXECUTION_DATE=2025-12-21T17:49:42.490411+00:00
AIRFLOW_CTX_DAG_RUN_ID=manual__2025-12-21T17:49:42.490411+00:00
[2025-12-21 17:49:46,725] {base.py:79} INFO - Using connection to: id: postgresql. Host: postgres, Port: 5432, Schema: postgres, Login: ***, Password: ***, extra: {}
[2025-12-21 17:49:46,730] {dbapi.py:225} INFO - Running statement: /* Query 5
 * 
 * 5. Найти имена и фамилии клиентов с топ-3 минимальной
      и топ-3 максимальной суммой транзакций за весь период
      (учесть клиентов, у которых нет заказов, приняв их сумму транзакций за 0).
*/

with transaction_amount_per_customer as (
	select
		o.customer_id,
		trunc(coalesce(sum(oi.quantity * oi.item_list_price_at_sale), 0)::numeric, 2) as amount
	from
		orders as o
	join order_items as oi on oi.order_id = o.order_id
	group by
		o.customer_id
),
transactions_rank as (
	select
		customer_id,
		amount,
		rank() over(order by amount asc) as top3_min_amount,
		rank() over(order by amount desc) as top3_max_amount
	from
		transaction_amount_per_customer
)
select
	c.first_name,
	c.last_name,
	coalesce(tr.amount, 0) as amount,
	coalesce(top3_min_amount, 0) as top3_min_amount,
	coalesce(top3_max_amount, 0) as top3_max_amount
from
	transactions_rank tr
right join (	select customer_id, first_name, coalesce(last_name, 'n\a') as last_name
			from customer) c on c.customer_id = tr.customer_id
where tr.top3_min_amount <=3 or tr.top3_max_amount <=3
;, parameters: None
[2025-12-21 17:49:46,759] {dbapi.py:233} INFO - Rows affected: 6
[2025-12-21 17:49:46,773] {taskinstance.py:1277} INFO - Marking task as SUCCESS. dag_id=SolovevEgor_HW_05_ds_2025, task_id=run_query1, execution_date=20251221T174942, start_date=20251221T174946, end_date=20251221T174946
[2025-12-21 17:49:46,827] {local_task_job.py:154} INFO - Task exited with return code 0
[2025-12-21 17:49:46,855] {local_task_job.py:264} INFO - 0 downstream tasks scheduled from follow-on schedule check
